# `BottEvent` Structure

For this `Task` you will be working with `BottEvent`s. A `BottEvent` is the core
data structure for all interactions within the system. It represents everything
from user messages to system actions.

## Common Properties

All `BottEvent` objects share the following base properties:

```json
{
  "id": "string",
  "type": "string",
  "createdAt": "a_few_seconds_ago",
  "user": {
    "id": "string",
    "name": "string"
  }
}
```

| Property    | Type     | Description                                                                            |
| ----------- | -------- | -------------------------------------------------------------------------------------- |
| `id`        | `string` | A unique identifier for the event.                                                     |
| `type`      | `string` | The type of event. See `Type-Based Properties` for more details.                       |
| `createdAt` | `string` | A relative time string (e.g., "a few seconds ago") indicating when the event occurred. |
| `user`      | `object` | The user who initiated the event. For system events, this is _your_ user identity.     |

### Attached Files

Each `BottEvent` object may have one or more attached files. These are not a
part of the JSON object, but rather added by the system under a
`--- Attached Files ---` header.

There may be files referenced in events that are missing - they were likely
pruned by the system to fit into context.

## Type-Based Properties

Then, there are a couple additional properties whose presence and shape depend
on the `type` of `BottEvent`.

| Property  | Type     | Description                                              |
| --------- | -------- | -------------------------------------------------------- |
| `parent`  | `object` | A pointer to a relevant parent event.                    |
| `details` | `object` | An object containing the application data for the event. |

Let's break down each `BottEvent` `type` and how their type-based properties are
structured:

### `message`

A standalone message. These events can be provided by a user or generated by the
system.

- **Required Properties**:
  - `details.content`: `string` - The text content of the message.

### `reply`

```json
{
  "id": "rply_4d5e6f",
  "type": "reply",
  "parent": {
    "id": "msg_1a2b3c"
  },
  "timestamp": "a minute ago",
  "user": { "id": "user_abc", "name": "Jane Smith" },
  "details": { "content": "Hello back!" },
  "_pipelineEvaluationMetadata": {
    "ratings": { "some_rating_scale_name": 2 }
  }
}
```

### `reaction`

An emoji reaction to a previous event. These events can be provided by a user or
generated by the system.

- **Required Properties**:
  - `parent`: `object` - A reference to the event being reacted to. Must contain
    an `id`.
  - `details.content`: `string` - The emoji character.

### `actionCall`

A system instruction to execute an asynchronous task. These events can only be
generated by the system.

- **Required Properties**:
  - `details.name`: `string` - The name of the action to execute.
  - `details.options`: `object` - The parameters for the action.

## `details.name` & `details.options` Breakdown

In a `BottEvent` of `type: "actionCall"`, the `details.name` and
`details.options` properties define which system action to run and with what
parameters. These are the actions currently available to the system:

<% for (const action of Object.values(actions)) { %>

##### Action: `<%= action.name %>`

<%= action.description %>

| Option                                                            | Description                      | Type                 | Allowed Values                                                                                  | Required                              |
| ----------------------------------------------------------------- | -------------------------------- | -------------------- | ----------------------------------------------------------------------------------------------- | ------------------------------------- |
| <% for (const option of Object.values(action.options ?? {})) { %> |                                  |                      |                                                                                                 |                                       |
| `<%= option.name %>`                                              | <%= option.description ?? '-' %> | `<%= option.type %>` | <% if (option.allowedValues) { %>`<%= option.allowedValues.join(", ") %>`<% } else { %>-<% } %> | <%= option.required ? "Yes" : "No" %> |
| <% } %>                                                           |                                  |                      |                                                                                                 |                                       |

<% } %>

---

## `_pipelineEvaluationMetadata`

The system injects a `_pipelineEvaluationMetadata` object into each event. This
metadata is separate from the core `BottEvent` data model and contains
evaluation results from the pipeline.

```json
"_pipelineEvaluationMetadata": {
  "ratings": { "some_rating_scale_name": 5 },
  "focusReasons": [{ "name": "whenAddressed", "instruction": "..." }],
  "outputReasons": ["ensurePotentialImpact"]
}
```

- **`ratings`**: Key-value pairs of rating scale names and their scores (1-5).
- **`focusReasons`**: A list of reasons why the system decided to focus on this
  input event.
- **`outputReasons`**: A list of reasons validation rules applied to this output
  event.

### Rating Scales

The `ratings` object contains scores based on these definitions:

<% for (const reason of settings.reasons.input) { %> <% for (const ratingScale
of reason.ratingScales ?? []) { %>

#### <%= ratingScale.name %>

Definition: <%= ratingScale.definition %>

<% for (const key of Object.keys(ratingScale.examples)) { %>

- **Examples of a rating of `<%= key %>`**: <% for (const example of
  ratingScale.examples[key]) { %>
  - <%= example %> <% } %> <% } %> <% } %> <% } %>

<% for (const reason of settings.reasons.output) { %> <% for (const ratingScale
of reason.ratingScales ?? []) { %>

#### <%= ratingScale.name %>

Definition: <%= ratingScale.definition %>

<% for (const key of Object.keys(ratingScale.examples)) { %>

- **Examples of a rating of `<%= key %>`**: <% for (const example of
  ratingScale.examples[key]) { %>
  - <%= example %> <% } %> <% } %> <% } %> <% } %>

---

## Example `BottEvent` Payloads

### `message`

```json
{
  "id": "msg_1a2b3c",
  "type": "message",
  "timestamp": "a few seconds ago",
  "user": {
    "id": "user_xyz",
    "name": "John Doe"
  },
  "details": {
    "content": "Hello, world!"
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 4
    },
    "focusReasons": [
      { "name": "whenAddressed", "instruction": "..." }
    ]
  }
}
```

### `reply`

```json
{
  "id": "rply_4d5e6f",
  "type": "reply",
  "parent": {
    "id": "msg_1a2b3c"
  },
  "timestamp": "a minute ago",
  "user": {
    "id": "user_abc",
    "name": "Jane Smith"
  },
  "details": {
    "content": "Hello back!"
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 2
    }
  }
}
```

### `reaction`

```json
{
  "id": "react_7g8h9i",
  "type": "reaction",
  "parent": {
    "id": "msg_1a2b3c"
  },
  "timestamp": "2 minutes ago",
  "user": {
    "id": "user_abc",
    "name": "Jane Smith"
  },
  "details": {
    "content": "üëç"
  },
  "_pipelineEvaluationMetadata": {}
}
```

### `actionCall`

```json
{
  "id": "act_j1k2l3",
  "type": "actionCall",
  "timestamp": "3 minutes ago",
  "user": {
    "id": "<%= user.id %>",
    "name": "<%= user.name %>"
  },
  "details": {
    "name": "generateMedia",
    "options": {
      "query": "cute kitten pictures"
    }
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 4
    },
    "outputReasons": ["ensurePotentialImpact"]
  }
}
```
