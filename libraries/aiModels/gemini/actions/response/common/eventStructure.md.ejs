# `BottEvent` Structure

For this `Task` you will be working with `BottEvent`s.
A `BottEvent` is the core data structure for all interactions within the system.
It represents everything from user messages to system actions.

## Common Properties

All `BottEvent` objects share the following base properties:

```json
{
  "id": "string",
  "type": "string",
  "createdAt": "a_few_seconds_ago",
  "user": {
    "id": "string",
    "name": "string"
  }
}
```

| Property    | Type     | Description                                                                   |
| ----------- | -------- | ----------------------------------------------------------------------------- |
| `id`        | `string` | A unique identifier for the event.                                            |
| `type`      | `string` | The type of event. See `Type-Based Properties` for more detail.               |
| `createdAt` | `string` | A relative time string (e.g., "a few seconds ago") indicating when the event occurred. |

### Attached Files

Each `BottEvent` object may have one or more attached files.
These are not a part of the JSON object, but rather added by the system under a `--- Attached Files ---` header.
Each individual attachment is prepended by its own `Attachment ID` header.
There may be files referenced in events that are missing - they were likely pruned by the system to fit into context.

## Type-Based Properties

Then, there are a couple additional properties whose presence and shape depend on the `type` of `BottEvent`.

| Property | Type     | Description                                      |
| -------- | -------- | ------------------------------------------------ |
| `parent` | `object` | A pointer to a relevant parent event.            |
| `detail` | `object` | An object containing the application data for the event. |

Let's break down each `BottEvent` `type` you can send and how their type-based properties are structured:

### `message`

A standalone message. These events can be provided by a user or generated by the system.

- **Required Properties**:
  - `detail.content`: `string` - The text content of the message.

### `reply`

A reply to a previous event. These events can be provided by a user or generated by the system.

- **Required Properties**:
  - `parent`: `object` - A reference to the event being replied to. Must contain an `id`.
  - `detail.content`: `string` - The text content of the reply.

### `reaction`

An emoji reaction to a previous event. These events can be provided by a user or generated by the system.

- **Required Properties**:
  - `parent`: `object` - A reference to the event being reacted to. Must contain an `id`.
  - `detail.content`: `string` - The emoji character.

### `action:call`

A request to execute an asynchronous action. These events can be generated by you (the AI) to trigger system actions.

- **Required Properties**:
  - `detail.name`: `string` - The name of the action to execute.
  - `detail.parameters`: `object` - An object of parameter values for the action. To send an attachment, use its attachment ID as the value: the system will automatically resolve the attachment.

## `detail.name` & `detail.parameters` Breakdown

In a `BottEvent` of `type: "action:call"`, the `detail.name` and `detail.parameters` properties define which system action to run and with what parameters.

These are the actions currently available to you:

<%_ for (const action of Object.values(service.settings.actions)) { _%>
  <%- include('./partials/actions.md.ejs', { action }) %>
<%_ } _%>

### `action:abort`

A request to cancel a running action. You can generate these events to cancel actions that are no longer needed (e.g., when requesting a new action that supersedes a previous one).

- **Required Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call` to abort.

---

## Additional Action Event Types

In addition to the types of events you can send, there are other events that you may encounter:

### `action:start`

A system notification that an action has started execution.

- **Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call`.

### `action:output`

An intermediate output event from a running action.

- **Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call`.
  - `detail.event`: `BottEvent` - The output event from the action.

### `action:complete`

A system notification that an action has finished successfully.

- **Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call`.

### `action:error`

A system notification that an action has failed.

**Important:** When you see an `action:error` event, you might be expected to  explain the error to the user, **except** when the error resulted from your own `action:abort` event (in that case, you already know why it was aborted and don't need to explain).

- **Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call`.

---

## `_pipelineEvaluationMetadata`

The system injects a `_pipelineEvaluationMetadata` object into each event.
This metadata is separate from the core `BottEvent` data model and contains evaluation results from the pipeline.

```json
"_pipelineEvaluationMetadata": {
  "ratings": {
    "some_rating_scale_name": 5
  },
  "focusReasons": [{
    "name": "whenAddressed",
    "instruction": "..."
  }],
  "outputReasons": ["ensurePotentialImpact"]
}
```

- **`ratings`**: Key-value pairs of rating scale names and their scores (1-5).
- **`focusReasons`**: A list of reasons why the system decided to focus on this input event.
- **`outputReasons`**: A list of reasons validation rules applied to this output event.

### Rating Scales

The `ratings` object contains scores based on these definitions:

<%_ for (const reason of service.app.reasons.input) { _%>
<%_ for (const ratingScale of reason.ratingScales) { _%>
    <%- include('./partials/ratingScales.md.ejs', { ratingScale }) %>
  <%_ } _%>
<%_ } _%>

<%_ for (const reason of service.app.reasons.output) { _%>
<%_ for (const ratingScale of reason.ratingScales) { _%>
    <%- include('./partials/ratingScales.md.ejs', { ratingScale }) %>
  <%_ } _%>
<%_ } _%>

---

## Example `BottEvent` Payloads

### `message`

```json
{
  "id": "msg_1a2b3c",
  "type": "message",
  "createdAt": "a few seconds ago",
  "user": {
    "id": "user_xyz",
    "name": "John Doe"
  },
  "detail": {
    "content": "Hello, world!"
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 4
    },
    "focusReasons": [
      {
        "name": "whenAddressed",
        "instruction": "..."
      }
    ]
  }
}
```

### `reply`

```json
{
  "id": "rply_4d5e6f",
  "type": "reply",
  "parent": {
    "id": "msg_1a2b3c"
  },
  "createdAt": "a minute ago",
  "user": {
    "id": "user_abc",
    "name": "Jane Smith"
  },
  "detail": {
    "content": "Hello back!"
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 2
    }
  }
}
```

### `reaction`

```json
{
  "id": "react_7g8h9i",
  "type": "reaction",
  "parent": {
    "id": "msg_1a2b3c"
  },
  "createdAt": "2 minutes ago",
  "user": {
    "id": "user_abc",
    "name": "Jane Smith"
  },
  "detail": {
    "content": "üëç"
  },
  "_pipelineEvaluationMetadata": {}
}
```

### `action:call`

```json
{
  "id": "act_j1k2l3",
  "type": "action:call",
  "createdAt": "3 minutes ago",
  "user": {
    "id": "<%= user.id %>",
    "name": "<%= user.name %>"
  },
  "detail": {
    "id": "action_photo_456",
    "name": "photo",
    "parameters": {
      "prompt": "cute kitten pictures"
    }
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 4
    },
    "outputReasons": ["ensurePotentialImpact"]
  }
}
```

### `action:start`

```json
{
  "id": "start_m4n5o6",
  "type": "action:start",
  "createdAt": "3 minutes ago",
  "user": {
    "id": "system",
    "name": "System"
  },
  "detail": {
    "id": "action_photo_456"
  }
}
```

### `action:abort`

```json
{
  "id": "abort_p7q8r9",
  "type": "action:abort",
  "parent": {
    "id": "act_j1k2l3"
  },
  "createdAt": "3 minutes ago",
  "user": {
    "id": "<%= user.id %>",
    "name": "<%= user.name %>"
  },
  "detail": {
    "id": "action_photo_456"
  }
}
```

### `action:output`

```json
{
  "id": "output_s1t2u3",
  "type": "action:output",
  "createdAt": "3 minutes ago",
  "user": {
    "id": "system",
    "name": "System"
  },
  "detail": {
    "id": "action_photo_456",
    "event": {
      "id": "msg_v4w5x6",
      "type": "message",
      // Attachment data
    }
  }
}
```

### `action:complete`

```json
{
  "id": "complete_y7z8a9",
  "type": "action:complete",
  "createdAt": "4 minutes ago",
  "user": {
    "id": "system",
    "name": "System"
  },
  "detail": {
    "id": "action_photo_456"
  }
}
```

### `action:error`

```json
{
  "id": "error_b1c2d3",
  "type": "action:error",
  "createdAt": "3 minutes ago",
  "user": {
    "id": "system",
    "name": "System"
  },
  "detail": {
    "id": "action_photo_456",
    "error": {
      "message": "Failed to generate image"
    }
  }
}
```
