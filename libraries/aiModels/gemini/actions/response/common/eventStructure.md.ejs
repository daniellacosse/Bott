<!-- deno-fmt-ignore-file -->
# `BottEvent` Structure

For this `Task` you will be working with `BottEvent`s.
A `BottEvent` is the core data structure for all interactions within the system.
It represents everything from user messages to system actions.

## Common Properties

All `BottEvent` objects share the following base properties:

```json
{
  "id": "string",
  "type": "string",
  "createdAt": "a_few_seconds_ago",
  "user": {
    "id": "string",
    "name": "string"
  }
}
```

| Property    | Type     | Description                                                                   |
| ----------- | -------- | ----------------------------------------------------------------------------- |
| `id`        | `string` | A unique identifier for the event.                                            |
| `type`      | `string` | The type of event. See `Type-Based Properties` for more detail.               |
| `createdAt` | `string` | A relative time string (e.g., "a few seconds ago") indicating when the event occurred. |
| `user`      | `object` | The user who initiated the event. For system events, this is _your_ user identity. |

### Attached Files

Each `BottEvent` object may have one or more attached files.
These are not a part of the JSON object, but rather added by the system under a `--- Attached Files ---` header.
There may be files referenced in events that are missing - they were likely pruned by the system to fit into context.

## Type-Based Properties

Then, there are a couple additional properties whose presence and shape depend on the `type` of `BottEvent`.

| Property | Type     | Description                                      |
| -------- | -------- | ------------------------------------------------ |
| `parent` | `object` | A pointer to a relevant parent event.            |
| `detail` | `object` | An object containing the application data for the event. |

Let's break down each `BottEvent` `type` and how their type-based properties are structured:

### `message`

A standalone message. These events can be provided by a user or generated by the system.

- **Required Properties**:
  - `detail.content`: `string` - The text content of the message.

### `reply`

```json
{
  "id": "rply_4d5e6f",
  "type": "reply",
  "parent": {
    "id": "msg_1a2b3c"
  },
  "createdAt": "a minute ago",
  "user": {
    "id": "user_abc",
    "name": "Jane Smith"
  },
  "detail": {
    "content": "Hello back!"
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 2
    }
  }
}
```

### `reaction`

An emoji reaction to a previous event. These events can be provided by a user or generated by the system.

- **Required Properties**:
  - `parent`: `object` - A reference to the event being reacted to. Must contain an `id`.
  - `detail.content`: `string` - The emoji character.

### `action:call`

A request to execute an asynchronous action. These events can be generated by you (the AI) to trigger system actions.

- **Required Properties**:
  - `detail.id`: `string` - A unique identifier for this action call.
  - `detail.name`: `string` - The name of the action to execute.
  - `detail.parameters`: `array` - An array of parameter objects for the action.

### `action:start`

A system notification that an action has begun execution. These events are **generated by the system only** (you don't generate these).

- **Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call`.
  - `detail.name`: `string` - The name of the action that started.

### `action:output`

An intermediate output event from a running action. These events are **generated by the system only** (you don't generate these).

- **Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call`.
  - `detail.name`: `string` - The name of the action producing output.
  - `detail.event`: `BottEvent` - The output event from the action.
  - `detail.shouldInterpretOutput`: `boolean` (optional) - Whether you should respond to this output.
  - `detail.shouldForwardOutput`: `boolean` (optional) - Whether this output should be forwarded to the channel.

### `action:complete`

A system notification that an action has finished successfully. These events are **generated by the system only** (you don't generate these). The system automatically handles cleanup when actions complete.

- **Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call`.
  - `detail.name`: `string` - The name of the action that completed.

### `action:error`

A system notification that an action has failed. These events are **generated by the system only** (you don't generate these). The system automatically handles cleanup when actions error.

- **Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call`.
  - `detail.name`: `string` - The name of the action that errored.
  - `detail.error`: `Error` - The error that occurred.

### `action:abort`

A request to cancel a running action. You can generate these events to cancel actions that are no longer needed (e.g., when starting a new action that supersedes a previous one).

- **Required Properties**:
  - `detail.id`: `string` - The unique identifier from the corresponding `action:call` to abort.
  - `detail.name`: `string` - The name of the action to abort.
  - `parent`: `object` - A reference to the `action:call` or `action:start` event being aborted. Must contain an `id`.

## `detail.name` & `detail.parameters` Breakdown

In a `BottEvent` of `type: "action:call"`, the `detail.name` and `detail.parameters` properties define which system action to run and with what parameters.

These are the actions currently available to you:

<% for (const action of Object.values(actions)) { %>
##### Action: `<%= action.name %>`

<%= action.instructions %>

<% if (action.parameters && action.parameters.length > 0) { %>
| Parameter | Description | Type | Allowed Values | Required |
| --------- | ----------- | ---- | -------------- | -------- |
<% for (const param of action.parameters) { %>| `<%= param.name %>` | <%= param.description ?? '-' %> | `<%= param.type %>` | <% if (param.type !== 'file' && param.allowedValues) { %>`<%= param.allowedValues.join(", ") %>`<% } else { %>-<% } %> | <%= param.required ? 'Yes' : 'No' %> |
<% } %>
<% } else { %>
*This action takes no parameters.*
<% } %>
<% } %>

---

## `_pipelineEvaluationMetadata`

The system injects a `_pipelineEvaluationMetadata` object into each event.
This metadata is separate from the core `BottEvent` data model and contains evaluation results from the pipeline.

```json
"_pipelineEvaluationMetadata": {
  "ratings": {
    "some_rating_scale_name": 5
  },
  "focusReasons": [{
    "name": "whenAddressed",
    "instruction": "..."
  }],
  "outputReasons": ["ensurePotentialImpact"]
}
```

- **`ratings`**: Key-value pairs of rating scale names and their scores (1-5).
- **`focusReasons`**: A list of reasons why the system decided to focus on this input event.
- **`outputReasons`**: A list of reasons validation rules applied to this output event.

### Rating Scales

The `ratings` object contains scores based on these definitions:

<% for (const reason of settings.reasons.input) { %>
<% for (const ratingScale of reason.ratingScales ?? []) { %>
#### <%= ratingScale.name %>

Definition: <%= ratingScale.definition %>

<% for (const key of Object.keys(ratingScale.examples)) { %>
- **Examples of a rating of `<%= key %>`**:
<% for (const example of ratingScale.examples[key]) { %>
  - <%= example %>
<% } %>
<% } %>
<% } %>
<% } %>

<% for (const reason of settings.reasons.output) { %>
<% for (const ratingScale of reason.ratingScales ?? []) { %>
#### <%= ratingScale.name %>

Definition: <%= ratingScale.definition %>

<% for (const key of Object.keys(ratingScale.examples)) { %>
- **Examples of a rating of `<%= key %>`**:
<% for (const example of ratingScale.examples[key]) { %>
  - <%= example %>
<% } %>
<% } %>
<% } %>
<% } %>

---

## Example `BottEvent` Payloads

### `message`

```json
{
  "id": "msg_1a2b3c",
  "type": "message",
  "createdAt": "a few seconds ago",
  "user": {
    "id": "user_xyz",
    "name": "John Doe"
  },
  "detail": {
    "content": "Hello, world!"
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 4
    },
    "focusReasons": [
      {
        "name": "whenAddressed",
        "instruction": "..."
      }
    ]
  }
}
```

### `reply`

```json
{
  "id": "rply_4d5e6f",
  "type": "reply",
  "parent": {
    "id": "msg_1a2b3c"
  },
  "createdAt": "a minute ago",
  "user": {
    "id": "user_abc",
    "name": "Jane Smith"
  },
  "detail": {
    "content": "Hello back!"
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 2
    }
  }
}
```

### `reaction`

```json
{
  "id": "react_7g8h9i",
  "type": "reaction",
  "parent": {
    "id": "msg_1a2b3c"
  },
  "createdAt": "2 minutes ago",
  "user": {
    "id": "user_abc",
    "name": "Jane Smith"
  },
  "detail": {
    "content": "üëç"
  },
  "_pipelineEvaluationMetadata": {}
}
```

### `action:call`

```json
{
  "id": "act_j1k2l3",
  "type": "action:call",
  "createdAt": "3 minutes ago",
  "user": {
    "id": "<%= user.id %>",
    "name": "<%= user.name %>"
  },
  "detail": {
    "id": "action_photo_456",
    "name": "photo",
    "parameters": [
      {
        "name": "prompt",
        "value": "cute kitten pictures",
        "type": "string"
      }
    ]
  },
  "_pipelineEvaluationMetadata": {
    "ratings": {
      "some_rating_scale_name": 4
    },
    "outputReasons": ["ensurePotentialImpact"]
  }
}
```

### `action:start`

```json
{
  "id": "start_m4n5o6",
  "type": "action:start",
  "createdAt": "3 minutes ago",
  "user": {
    "id": "system",
    "name": "System"
  },
  "detail": {
    "id": "action_photo_456",
    "name": "photo"
  }
}
```

### `action:abort`

```json
{
  "id": "abort_p7q8r9",
  "type": "action:abort",
  "parent": {
    "id": "act_j1k2l3"
  },
  "createdAt": "3 minutes ago",
  "user": {
    "id": "<%= user.id %>",
    "name": "<%= user.name %>"
  },
  "detail": {
    "id": "action_photo_456",
    "name": "photo"
  }
}
```

### `action:output`

```json
{
  "id": "output_s1t2u3",
  "type": "action:output",
  "createdAt": "3 minutes ago",
  "user": {
    "id": "system",
    "name": "System"
  },
  "detail": {
    "id": "action_photo_456",
    "name": "photo",
    "event": {
      "id": "msg_v4w5x6",
      "type": "message",
      "detail": {
        "content": "Here's your image!"
      }
    },
    "shouldInterpretOutput": false,
    "shouldForwardOutput": true
  }
}
```

### `action:complete`

```json
{
  "id": "complete_y7z8a9",
  "type": "action:complete",
  "createdAt": "4 minutes ago",
  "user": {
    "id": "system",
    "name": "System"
  },
  "detail": {
    "id": "action_photo_456",
    "name": "photo"
  }
}
```

### `action:error`

```json
{
  "id": "error_b1c2d3",
  "type": "action:error",
  "createdAt": "3 minutes ago",
  "user": {
    "id": "system",
    "name": "System"
  },
  "detail": {
    "id": "action_photo_456",
    "name": "photo",
    "error": {
      "message": "Failed to generate image"
    }
  }
}
```
