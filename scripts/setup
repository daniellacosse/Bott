#!/usr/bin/env bash
# @license
# This file is part of Bott.
#
# This project is dual-licensed:
# - Non-commercial use: AGPLv3 (see LICENSE file for full text).
# - Commercial use: Proprietary License (contact D@nielLaCos.se for details).
#
# Copyright (C) 2025 DanielLaCos.se

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common/logger.sh"

ENV="${ENV:-devcontainer}"

main() {
  log <<EOF
Bott Setup
==========
EOF
  if [[ "$OSTYPE" == "darwin"* ]]; then
    info_log "Detected macOS"
    
    if ! command -v brew &> /dev/null; then
      info_log "Installing Homebrew..."
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    
    info_log "Installing dependencies via Homebrew..."
    brew bundle
  elif [[ "$OSTYPE" == "linux-gnu"* && command -v apt-get &> /dev/null ]]; then
    info_log "Detected Linux. Installing dependencies via apt-get..."
      
    if ! command -v gcloud &> /dev/null; then
      info_log "Installing Google Cloud SDK..."
      sudo apt-get update
      sudo apt-get install -y apt-transport-https ca-certificates gnupg curl
      curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
      echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
      sudo apt-get update
      sudo apt-get install -y google-cloud-cli
    fi
    
    if ! command -v deno &> /dev/null; then
      info_log "Installing Deno..."
      curl -fsSL https://deno.land/install.sh | sh
      info_log "Please add Deno to your PATH: export PATH=\"\$HOME/.deno/bin:\$PATH\""
    fi
  else
    warn_log <<EOF
Detected unsupported system: $OSTYPE
Please manually install dependencies:
  - Google Cloud SDK (gcloud)
  - Deno runtime
EOF
  fi
    
  if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" 2>/dev/null | grep -q .; then
    info_log "Authenticating with Google Cloud..."
    gcloud auth application-default login
  fi
  
  local env_file=".env.$ENV.yml"
  if [ ! -f "$env_file" ]; then
    info_log "Creating $env_file from .env.example.yml..."
    cp .env.example.yml "$env_file"
    
    local editor="${EDITOR:-${VISUAL:-vi}}"
    read -r -p "Complete $env_file in $editor? [Y/n] " open_editor
    open_editor=${open_editor:-Y}
    if [[ "$editor" && "$open_editor" =~ ^[Yy]$ ]]; then
      "$editor" "$env_file"
    else
      info_log "Please complete the $env_file with your configuration."
      exit 0 # Exit, but setup is not complete
    fi
  fi
  
  info_log "Setup complete!"
}

main "$@"
