#!/usr/bin/env bash
# @license
# This file is part of Bott.
#
# This project is dual-licensed:
# - Non-commercial use: AGPLv3 (see LICENSE file for full text).
# - Commercial use: Proprietary License (contact D@nielLaCos.se for details).
#
# Copyright (C) 2025 DanielLaCos.se

set -euo pipefail

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Default values
SERVICE_NAME="${SERVICE_NAME:-bott-service}"
ENV_FILE="${ENV_FILE:-.env.production}"
ALLOW_UNAUTHENTICATED="${ALLOW_UNAUTHENTICATED:-true}"

# Helper functions
log_info() {
  echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1"
}

# Check if gcloud is installed
check_gcloud() {
  if ! command -v gcloud &> /dev/null; then
    log_error "gcloud CLI is not installed. Please install it from https://cloud.google.com/sdk/docs/install"
    exit 1
  fi
  log_info "gcloud CLI found"
}

# Ensure user is authenticated
ensure_authenticated() {
  if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" 2>/dev/null | grep -q .; then
    log_warn "Not authenticated with gcloud."
    log_info "Running: gcloud auth application-default login"
    gcloud auth application-default login
  else
    log_info "Already authenticated with gcloud"
  fi
}

# Setup or verify GCP project
setup_project() {
  local project_id="${GOOGLE_PROJECT_ID:-}"
  
  if [ -z "$project_id" ]; then
    log_warn "GOOGLE_PROJECT_ID not set in environment file."
    read -r -p "Enter your GCP Project ID (or press Enter to be prompted for a name): " project_id
    
    if [ -z "$project_id" ]; then
      # Prompt for a project name
      read -r -p "Enter a unique project ID (e.g., my-bott-bot): " project_id
      if [ -z "$project_id" ]; then
        log_error "Project ID is required"
        exit 1
      fi
      log_info "Creating new project: $project_id"
      
      if gcloud projects create "$project_id" 2>/dev/null; then
        log_info "Project created successfully: $project_id"
      else
        log_error "Failed to create project. You may need to provide a unique project ID."
        read -r -p "Enter a unique GCP Project ID: " project_id
      fi
    fi
    
    export GOOGLE_PROJECT_ID="$project_id"
    
    # Update .env file with the project ID
    if [ -f "$ENV_FILE" ]; then
      if grep -q "^GOOGLE_PROJECT_ID=" "$ENV_FILE"; then
        # Use | as delimiter to avoid issues with special characters
        sed -i.bak "s|^GOOGLE_PROJECT_ID=.*|GOOGLE_PROJECT_ID=$project_id|" "$ENV_FILE"
      else
        echo "GOOGLE_PROJECT_ID=$project_id" >> "$ENV_FILE"
      fi
      rm -f "${ENV_FILE}.bak"
      log_info "Updated $ENV_FILE with GOOGLE_PROJECT_ID=$project_id"
    fi
  fi
  
  # Set the project
  log_info "Setting active project to: $GOOGLE_PROJECT_ID"
  gcloud config set project "$GOOGLE_PROJECT_ID" 2>/dev/null || true
  
  # Check if project exists
  if ! gcloud projects describe "$GOOGLE_PROJECT_ID" &>/dev/null; then
    log_error "Project $GOOGLE_PROJECT_ID does not exist or you don't have access to it."
    exit 1
  fi
  
  log_info "Project verified: $GOOGLE_PROJECT_ID"
}

# Enable required APIs
enable_apis() {
  log_info "Enabling required APIs..."
  
  local apis=(
    "aiplatform.googleapis.com"
    "storage.googleapis.com"
    "run.googleapis.com"
    "artifactregistry.googleapis.com"
    "cloudbuild.googleapis.com"
  )
  
  for api in "${apis[@]}"; do
    if gcloud services list --enabled --filter="name:$api" --format="value(name)" 2>/dev/null | grep -q "$api"; then
      log_info "API already enabled: $api"
    else
      log_info "Enabling API: $api"
      if ! gcloud services enable "$api" --project="$GOOGLE_PROJECT_ID" 2>&1; then
        log_warn "Failed to enable $api"
        log_warn "This may be due to:"
        log_warn "  - Billing not enabled on the project"
        log_warn "  - Insufficient permissions"
        log_warn "  - API not available in your region"
        log_warn "You may need to enable this manually in the GCP Console"
      fi
    fi
  done
}

# Configure service account permissions
configure_service_account() {
  log_info "Configuring service account permissions..."
  
  # Get the Cloud Build service account
  local project_number
  project_number=$(gcloud projects describe "$GOOGLE_PROJECT_ID" --format="value(projectNumber)" 2>/dev/null || echo "")
  
  if [ -z "$project_number" ]; then
    log_warn "Could not determine project number. Skipping IAM configuration."
    return 0
  fi
  
  local service_account="${project_number}@cloudbuild.gserviceaccount.com"
  log_info "Service account: $service_account"
  
  local roles=(
    "roles/aiplatform.user"
    "roles/storage.objectAdmin"
  )
  
  for role in "${roles[@]}"; do
    log_info "Adding role: $role"
    gcloud projects add-iam-policy-binding "$GOOGLE_PROJECT_ID" \
      --member="serviceAccount:$service_account" \
      --role="$role" \
      2>/dev/null || log_warn "Failed to add role $role (may already exist)"
  done
}

# Check if .env.production file exists
check_env_file() {
  if [ ! -f "$ENV_FILE" ]; then
    log_error "Environment file '$ENV_FILE' not found."
    log_info "Please create it from .env.example:"
    log_info "  cp .env.example $ENV_FILE"
    exit 1
  fi
  log_info "Environment file '$ENV_FILE' found"
}

# Validate required environment variables in .env file
validate_env_vars() {
  local required_vars=("GOOGLE_PROJECT_ID" "GOOGLE_PROJECT_LOCATION")
  local missing_vars=()

  # Source the env file to check for required variables
  while IFS='=' read -r key value; do
    # Skip comments and empty lines
    [[ $key =~ ^#.*$ ]] && continue
    [[ -z $key ]] && continue
    
    # Remove leading/trailing whitespace and quotes from value
    value=$(echo "$value" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' -e 's/^"\(.*\)"$/\1/' -e "s/^'\(.*\)'$/\1/")
    
    # Export the variable
    export "$key=$value"
  done < "$ENV_FILE"

  for var in "${required_vars[@]}"; do
    if [ -z "${!var:-}" ]; then
      missing_vars+=("$var")
    fi
  done

  if [ ${#missing_vars[@]} -gt 0 ]; then
    log_error "Missing required environment variables in $ENV_FILE:"
    for var in "${missing_vars[@]}"; do
      echo "  - $var"
    done
    exit 1
  fi

  log_info "All required environment variables are set"
}

# Get or prompt for region
get_region() {
  if [ -z "${REGION:-}" ]; then
    log_info "No REGION environment variable set."
    read -r -p "Enter GCP region for deployment (e.g., us-central1): " REGION
    export REGION
  fi
  log_info "Deploying to region: $REGION"
}

# Convert .env file to YAML format for gcloud
convert_env_to_yaml() {
  local yaml_file
  yaml_file=$(mktemp /tmp/bott-deploy-env-XXXXXX.yaml)
  
  # Create YAML file from .env
  while IFS='=' read -r key value; do
    # Skip comments and empty lines
    [[ $key =~ ^#.*$ ]] && continue
    [[ -z $key ]] && continue
    
    # Remove leading/trailing whitespace and quotes from value
    value=$(echo "$value" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' -e 's/^"\(.*\)"$/\1/' -e "s/^'\(.*\)'$/\1/")
    
    # Write to YAML file
    echo "$key: \"$value\"" >> "$yaml_file"
  done < "$ENV_FILE"
  
  echo "$yaml_file"
}

# Deploy to Cloud Run
deploy() {
  log_info "Starting deployment to Google Cloud Run..."
  log_info "Service: $SERVICE_NAME"
  log_info "Region: $REGION"
  
  # Convert env file to YAML
  log_info "Converting $ENV_FILE to YAML format..."
  local yaml_env_file
  yaml_env_file=$(convert_env_to_yaml)
  
  local deploy_args=(
    "run" "deploy" "$SERVICE_NAME"
    "--source" "."
    "--region" "$REGION"
    "--project" "$GOOGLE_PROJECT_ID"
    "--env-vars-file" "$yaml_env_file"
  )

  # Add platform and other options from app.json
  deploy_args+=(
    "--platform" "managed"
    "--cpu" "1"
    "--memory" "1.5Gi"
    "--max-instances" "1"
    "--port" "8080"
  )

  if [ "$ALLOW_UNAUTHENTICATED" = "true" ]; then
    deploy_args+=("--allow-unauthenticated")
  fi

  log_info "Executing: gcloud ${deploy_args[*]}"
  
  local exit_code=0
  if gcloud "${deploy_args[@]}"; then
    log_info "Deployment successful!"
    
    # Get the service URL
    SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" --region="$REGION" --project="$GOOGLE_PROJECT_ID" --format="value(status.url)" 2>/dev/null || echo "")
    if [ -n "$SERVICE_URL" ]; then
      log_info "Service URL: $SERVICE_URL"
    fi
  else
    log_error "Deployment failed!"
    exit_code=1
  fi
  
  # Clean up temporary file
  rm -f "$yaml_env_file"
  
  return $exit_code
}

# Main execution
main() {
  log_info "Bott Deployment Script"
  log_info "======================"
  
  check_gcloud
  ensure_authenticated
  check_env_file
  validate_env_vars
  setup_project
  enable_apis
  configure_service_account
  get_region
  
  if deploy; then
    echo ""
    log_info "Deployment complete!"
    log_info "To view logs, run: ./scripts/logs"
    exit 0
  else
    exit 1
  fi
}

# Run main function
main "$@"
