#!/usr/bin/env bash
# @license
# This file is part of Bott.
#
# This project is dual-licensed:
# - Non-commercial use: AGPLv3 (see LICENSE file for full text).
# - Commercial use: Proprietary License (contact D@nielLaCos.se for details).
#
# Copyright (C) 2025 DanielLaCos.se

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common/logger.sh"

ENV="${ENV:-production}"
ENV_FILE="${ENV_FILE:-.env.$ENV.yml}"

GCP_SERVICE_NAME="${GCP_SERVICE_NAME:-bott-$ENV}"
GCP_ALLOW_UNAUTHENTICATED="${GCP_ALLOW_UNAUTHENTICATED:-true}"
GCP_REGION="us-central1"

main() {
  log <<EOF
Bott Deployment
===============
EOF
  source "$ENV_FILE"

  setup_project
  deploy
}

setup_project() {
  if ! gcloud auth list --filter=status:ACTIVE --format="value(account)" 2>/dev/null | grep -q .; then
    error_log "Please authenticate with gcloud before running this script."
    exit 1
  fi

  local project_id="${GCP_PROJECT_ID:-}"
  
  if [ -z "$project_id" ]; then
    read -r -p "Enter your GCP Project ID (or press Enter to auto-generate): " project_id
    
    if [ -z "$project_id" ]; then
      local unique_suffix
      unique_suffix=$(openssl rand -hex 4 2>/dev/null || echo "$RANDOM$RANDOM")
      project_id="bott-$(date +%s)-${unique_suffix}"
      info_log "Auto-generating project ID: $project_id"
      info_log "Creating new project: $project_id"
      
      if gcloud projects create "$project_id" 2>/dev/null; then
        info_log "Project created successfully: $project_id"
      else
        error_log "Failed to create project. You may need to provide a unique project ID."
        read -r -p "Enter a unique GCP Project ID: " project_id
      fi
    fi
    
    export GCP_PROJECT_ID="$project_id"
    
    if [ -f "$ENV_FILE" ]; then
      if grep -q "^GCP_PROJECT_ID=" "$ENV_FILE"; then
        if [[ "$OSTYPE" == "darwin"* ]]; then
          sed -i .bak "s|^GCP_PROJECT_ID=.*|GCP_PROJECT_ID=$project_id|" "$ENV_FILE"
        else
          sed -i.bak "s|^GCP_PROJECT_ID=.*|GCP_PROJECT_ID=$project_id|" "$ENV_FILE"
        fi
      else
        echo "GCP_PROJECT_ID=$project_id" >> "$ENV_FILE"
      fi
      rm -f "${ENV_FILE}.bak"
      info_log "Updated $ENV_FILE with GCP_PROJECT_ID=$project_id"
    fi
  fi
  
  if ! gcloud projects describe "$GCP_PROJECT_ID" &>/dev/null; then
    error_log "Project $GCP_PROJECT_ID does not exist or you don't have access to it."
    exit 1
  fi
  
  info_log "Setting active project to: $GCP_PROJECT_ID"
  gcloud config set project "$GCP_PROJECT_ID" 2>/dev/null || true

  info_log "Enabling required APIs..."
  local apis=(
    "aiplatform.googleapis.com"
    "storage.googleapis.com"
    "run.googleapis.com"
    "artifactregistry.googleapis.com"
    "cloudbuild.googleapis.com"
  )
  
  for api in "${apis[@]}"; do
    if gcloud services list --enabled --filter="name:$api" --format="value(name)" 2>/dev/null | grep -q "$api"; then
      info_log "API already enabled: $api"
    else
      info_log "Enabling API: $api"
      if ! gcloud services enable "$api" --project="$GCP_PROJECT_ID" 2>&1; then
        warn_log <<EOF
Failed to enable $api
This may be due to:
  - Billing not enabled on the project
  - Insufficient permissions
  - API not available in your region
You may need to enable this manually in the GCP Console
EOF
      fi
    fi
  done

  info_log "Configuring service account permissions..."
  
  local project_number
  project_number=$(gcloud projects describe "$GCP_PROJECT_ID" --format="value(projectNumber)" 2>/dev/null || echo "")
  
  if [ -z "$project_number" ]; then
    warn_log "Could not determine project number. Skipping IAM configuration."
    return 0
  fi
  
  local service_account="${project_number}@cloudbuild.gserviceaccount.com"
  info_log "Service account: $service_account"
  
  local roles=(
    "roles/aiplatform.user"
    "roles/storage.objectAdmin"
  )
  
  for role in "${roles[@]}"; do
    info_log "Adding role: $role"
    gcloud projects add-iam-policy-binding "$GCP_PROJECT_ID" \
      --member="serviceAccount:$service_account" \
      --role="$role" \
      2>/dev/null || warn_log "Failed to add role $role (may already exist)"
  done
}

deploy() {
  info_log "Starting deployment to Google Cloud Run..."
  info_log "Service: $GCP_SERVICE_NAME"
  info_log "Region: $GCP_REGION"
  
  local deploy_args=(
    "run" "deploy" "$GCP_SERVICE_NAME"
    "--source" "."
    "--region" "$GCP_REGION"
    "--project" "$GCP_PROJECT_ID"
    "--env-vars-file" "$ENV_FILE"
    "--platform" "managed"
    "--cpu" "1"
    "--memory" "1.5Gi"
    "--max-instances" "1"
    "--port" "8080"
  )

  if [ "$GCP_ALLOW_UNAUTHENTICATED" = "true" ]; then
    deploy_args+=("--allow-unauthenticated")
  fi
  
  if gcloud "${deploy_args[@]}"; then
    info_log "Deployment successful! To view logs, run: ./scripts/logs"
    
    GCP_SERVICE_URL=$(gcloud run services describe "$GCP_SERVICE_NAME" --region="$GCP_REGION" --project="$GCP_PROJECT_ID" --format="value(status.url)" 2>/dev/null || echo "")

    info_log "GCP Service URL: ${GCP_SERVICE_URL:-N/A}"

    exit 0
  else
    error_log "Deployment failed!"
    exit 1
  fi
}

main "$@"
