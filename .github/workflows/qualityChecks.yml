name: Quality Checks

on: [push]

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Clone Repository
        uses: actions/checkout@v4

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.5.x

      - name: Lint Code
        run: deno fmt --check && deno lint

  unit_tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Clone Repository
        uses: actions/checkout@v4

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.5.x

      - name: Run Tests
        run: |
          deno test --allow-all --coverage=.output/cov_profile
          mkdir -p .output/coverage
          deno coverage .output/cov_profile --lcov --output=.output/coverage/lcov.info

      - name: Upload Coverage
        uses: qltysh/qlty-action/coverage@v2
        with:
          token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
          files: .output/coverage/lcov.info

  bench:
    name: Bench
    runs-on: ubuntu-latest

    steps:
      - name: Clone Repository
        uses: actions/checkout@v4

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.5.x

      - name: Run Benchmarks
        run: |
          # Cache dependencies first to avoid download noise in benchmark output
          deno bench --allow-all --quiet > /dev/null 2>&1 || true
          # Now run benchmarks and capture clean output
          deno bench --allow-all > bench-results.txt 2>&1 || true
          {
            echo "## Benchmark Results"
            echo '```'
            cat bench-results.txt
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
          cat bench-results.txt

  licensing:
    name: License Headers
    runs-on: ubuntu-latest

    steps:
      - name: Clone Repository
        uses: actions/checkout@v4

      - name: Check Files
        run: |
          REQUIRED_HEADER_SNIPPET="This project is dual-licensed:"
          MISSING_HEADERS_COUNT=$(grep -L "${REQUIRED_HEADER_SNIPPET}" $(find . -name "*.ts" -o -name "*.sql") | wc -l)

          if [ "$MISSING_HEADERS_COUNT" -gt 0 ]; then
            echo "Error: The following files are missing the required license header:"
            grep -L "${REQUIRED_HEADER_SNIPPET}" $(find . -name "*.ts" -o -name "*.sql")
            exit 1
          else
            echo "All files have the required license header."
          fi
