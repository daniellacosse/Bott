name: Quality Checks

on: [push]

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      all_changed_files: ${{ steps.changed-files.outputs.all_changed_files }}
      changed_module_paths: ${{ steps.generate-paths.outputs.module_paths }}
      root_changed: ${{ steps.changed-files.outputs.root_any_changed }}
      any_changes: ${{ steps.generate-paths.outputs.any_changes }}
      is_main_branch: ${{ github.ref == 'refs/heads/main' }}

    steps:
      - name: Clone Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files_yaml: |
            model:
              - 'model/**'
            log:
              - 'libraries/infrastructure/log/**'
            service:
              - 'libraries/infrastructure/service/**'
            storage:
              - 'libraries/infrastructure/storage/**'
            task:
              - 'libraries/infrastructure/task/**'
            gemini:
              - 'libraries/aiModels/gemini/**'
            discord:
              - 'libraries/chatSpaces/discord/**'
            app:
              - 'app/**'
            root:
              - '*.ts'
              - '*.jsonc'
              - '*.json'
              - '.github/workflows/**'

      - name: Generate Module Paths
        id: generate-paths
        run: |
          module_paths=""
          
          if [ "${{ steps.changed-files.outputs.model_any_changed }}" == "true" ]; then
            module_paths="$module_paths model/"
          fi
          if [ "${{ steps.changed-files.outputs.log_any_changed }}" == "true" ]; then
            module_paths="$module_paths libraries/infrastructure/log/"
          fi
          if [ "${{ steps.changed-files.outputs.service_any_changed }}" == "true" ]; then
            module_paths="$module_paths libraries/infrastructure/service/"
          fi
          if [ "${{ steps.changed-files.outputs.storage_any_changed }}" == "true" ]; then
            module_paths="$module_paths libraries/infrastructure/storage/"
          fi
          if [ "${{ steps.changed-files.outputs.task_any_changed }}" == "true" ]; then
            module_paths="$module_paths libraries/infrastructure/task/"
          fi
          if [ "${{ steps.changed-files.outputs.gemini_any_changed }}" == "true" ]; then
            module_paths="$module_paths libraries/aiModels/gemini/"
          fi
          if [ "${{ steps.changed-files.outputs.discord_any_changed }}" == "true" ]; then
            module_paths="$module_paths libraries/chatSpaces/discord/"
          fi
          if [ "${{ steps.changed-files.outputs.app_any_changed }}" == "true" ]; then
            module_paths="$module_paths app/"
          fi
          
          # Trim leading and trailing whitespace
          module_paths="${module_paths# }"
          module_paths="${module_paths% }"
          
          echo "module_paths=$module_paths" >> $GITHUB_OUTPUT
          
          if [ -n "$module_paths" ] || [ "${{ steps.changed-files.outputs.root_any_changed }}" == "true" ]; then
            echo "any_changes=true" >> $GITHUB_OUTPUT
          else
            echo "any_changes=false" >> $GITHUB_OUTPUT
          fi
          
          echo "Changed module paths: $module_paths"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.is_main_branch == 'true' || needs.detect-changes.outputs.any_changes == 'true'

    steps:
      - name: Clone Repository
        uses: actions/checkout@v4

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.5.x

      - name: Lint Code (All Files)
        if: needs.detect-changes.outputs.is_main_branch == 'true'
        run: deno fmt --check && deno lint

      - name: Lint Code (Changed Files Only)
        if: needs.detect-changes.outputs.is_main_branch != 'true'
        run: |
          changed_files="${{ needs.detect-changes.outputs.all_changed_files }}"
          if [ -n "$changed_files" ]; then
            echo "Linting changed files: $changed_files"
            # shellcheck disable=SC2086
            deno fmt --check $changed_files
            # shellcheck disable=SC2086
            deno lint $changed_files
          else
            echo "No files to lint"
          fi

  unit_tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.is_main_branch == 'true' || needs.detect-changes.outputs.any_changes == 'true'

    steps:
      - name: Clone Repository
        uses: actions/checkout@v4

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.5.x

      - name: Run Tests (All Modules)
        if: needs.detect-changes.outputs.is_main_branch == 'true'
        run: |
          deno test --allow-all --coverage=.output/cov_profile
          mkdir -p .output/coverage
          deno coverage .output/cov_profile --lcov --output=.output/coverage/lcov.info

      - name: Run Tests (Changed Modules Only)
        if: needs.detect-changes.outputs.is_main_branch != 'true'
        run: |
          # When root files change (constants.ts, deno.jsonc, workflows), run all tests
          # since these files affect the entire workspace
          if [ "${{ needs.detect-changes.outputs.root_changed }}" == "true" ]; then
            echo "Root files changed - running all tests"
            deno test --allow-all --coverage=.output/cov_profile
          else
            module_paths="${{ needs.detect-changes.outputs.changed_module_paths }}"
            
            if [ -n "$module_paths" ]; then
              echo "Running tests for changed modules: $module_paths"
              # shellcheck disable=SC2086
              deno test --allow-all --coverage=.output/cov_profile $module_paths
            else
              echo "No modules to test"
              exit 0
            fi
          fi
          
          mkdir -p .output/coverage
          deno coverage .output/cov_profile --lcov --output=.output/coverage/lcov.info

      - name: Upload Coverage
        if: always() && hashFiles('.output/coverage/lcov.info') != ''
        uses: qltysh/qlty-action/coverage@v2
        with:
          token: ${{ secrets.QLTY_COVERAGE_TOKEN }}
          files: .output/coverage/lcov.info

  bench:
    name: Bench
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.is_main_branch == 'true' || needs.detect-changes.outputs.any_changes == 'true'

    steps:
      - name: Clone Repository
        uses: actions/checkout@v4

      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.5.x

      - name: Run Benchmarks (All Modules)
        if: needs.detect-changes.outputs.is_main_branch == 'true'
        run: |
          # Cache dependencies first to avoid download noise in benchmark output
          deno bench --allow-all --quiet > /dev/null 2>&1 || true
          # Now run benchmarks and capture clean output
          deno bench --allow-all > bench-results-raw.txt 2>&1 || true
          # Strip ANSI color codes from the output
          sed 's/\x1b\[[0-9;]*m//g' bench-results-raw.txt > bench-results.txt
          {
            echo "## Benchmark Results"
            echo '```'
            cat bench-results.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
          cat bench-results.txt

      - name: Run Benchmarks (Changed Modules Only)
        if: needs.detect-changes.outputs.is_main_branch != 'true'
        run: |
          # When root files change (constants.ts, deno.jsonc, workflows), run all benchmarks
          # since these files affect the entire workspace
          if [ "${{ needs.detect-changes.outputs.root_changed }}" == "true" ]; then
            echo "Root files changed - running all benchmarks"
            # Cache dependencies first to avoid download noise in benchmark output
            deno bench --allow-all --quiet > /dev/null 2>&1 || true
            # Now run benchmarks and capture clean output
            deno bench --allow-all > bench-results-raw.txt 2>&1 || true
          else
            module_paths="${{ needs.detect-changes.outputs.changed_module_paths }}"
            
            if [ -n "$module_paths" ]; then
              echo "Running benchmarks for changed modules: $module_paths"
              # Cache dependencies first to avoid download noise in benchmark output
              # shellcheck disable=SC2086
              deno bench --allow-all --quiet $module_paths > /dev/null 2>&1 || true
              # Now run benchmarks and capture clean output
              # shellcheck disable=SC2086
              deno bench --allow-all $module_paths > bench-results-raw.txt 2>&1 || true
            else
              echo "No modules to benchmark"
              exit 0
            fi
          fi
          
          # Strip ANSI color codes from the output
          sed 's/\x1b\[[0-9;]*m//g' bench-results-raw.txt > bench-results.txt
          {
            echo "## Benchmark Results (Changed Modules)"
            echo '```'
            cat bench-results.txt
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
          cat bench-results.txt

  licensing:
    name: License Headers
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.is_main_branch == 'true' || needs.detect-changes.outputs.any_changes == 'true'

    steps:
      - name: Clone Repository
        uses: actions/checkout@v4

      - name: Check Files (All)
        if: needs.detect-changes.outputs.is_main_branch == 'true'
        run: |
          REQUIRED_HEADER_SNIPPET="This project is dual-licensed:"
          # shellcheck disable=SC2046
          MISSING_HEADERS_COUNT=$(grep -L "${REQUIRED_HEADER_SNIPPET}" $(find . -name "*.ts" -o -name "*.sql") | wc -l)

          if [ "$MISSING_HEADERS_COUNT" -gt 0 ]; then
            echo "Error: The following files are missing the required license header:"
            # shellcheck disable=SC2046
            grep -L "${REQUIRED_HEADER_SNIPPET}" $(find . -name "*.ts" -o -name "*.sql")
            exit 1
          else
            echo "All files have the required license header."
          fi

      - name: Check Files (Changed Only)
        if: needs.detect-changes.outputs.is_main_branch != 'true'
        run: |
          REQUIRED_HEADER_SNIPPET="This project is dual-licensed:"
          changed_files="${{ needs.detect-changes.outputs.all_changed_files }}"
          
          # Filter for only .ts and .sql files
          ts_sql_files=""
          for file in $changed_files; do
            if [[ "$file" == *.ts ]] || [[ "$file" == *.sql ]]; then
              if [ -f "$file" ]; then
                ts_sql_files="$ts_sql_files $file"
              fi
            fi
          done
          
          if [ -z "$ts_sql_files" ]; then
            echo "No .ts or .sql files changed"
            exit 0
          fi
          
          # shellcheck disable=SC2086
          MISSING_HEADERS_COUNT=$(grep -L "${REQUIRED_HEADER_SNIPPET}" $ts_sql_files 2>/dev/null | wc -l)

          if [ "$MISSING_HEADERS_COUNT" -gt 0 ]; then
            echo "Error: The following changed files are missing the required license header:"
            # shellcheck disable=SC2086
            grep -L "${REQUIRED_HEADER_SNIPPET}" $ts_sql_files
            exit 1
          else
            echo "All changed .ts and .sql files have the required license header."
          fi
